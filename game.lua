tfm.exec.disableAutoNewGame(true)
tfm.exec.disableAutoShaman(true)
tfm.exec.disableAutoTimeLeft(true)
tfm.exec.disableAfkDeath(true)
tfm.exec.newGame([[<C><P F="0"/><Z><S><S X="79" o="aac4d2" L="162" Y="165" c="4" H="334" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="169" o="6d9bb3" L="144" Y="201" c="4" H="285" P="0,0,0.3,0.2,-10,0,0,0" T="12"/><S X="400" o="a18600" L="803" Y="364" H="78" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="296" o="285b74" L="52" Y="207" c="4" H="240" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="367" o="b5d8ea" L="113" Y="178" c="4" H="300" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="528" o="3d657a" L="61" Y="236" c="4" H="182" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="653" o="a5c5d6" L="197" Y="164" c="4" H="332" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="485" o="dfb218" L="78" Y="293" c="4" H="69" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="435" o="5a4c06" L="75" Y="277" c="4" H="104" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="338" o="0e67e7" L="12" Y="261" c="4" H="131" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="338" o="0fa5f1" L="36" Y="197" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="13"/><S X="337" o="0b56c2" L="28" Y="253" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="338" o="324650" L="10" Y="155" H="22" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="338" o="0b56c2" L="17" Y="150" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="338" o="0e67e7" L="10" Y="128" c="4" H="38" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="721" o="7c99a7" L="111" Y="212" c="4" H="235" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="56" o="480312" L="10" Y="310" c="4" H="36" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="765" o="480312" L="10" Y="292" c="4" H="71" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="592" o="480312" L="10" Y="279" c="4" H="94" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="241" o="480312" L="10" Y="295" c="4" H="62" P="0,0,0.3,0.2,0,0,0,0" T="12"/><S X="753" o="055111" L="26" Y="248" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="13"/><S X="755" o="058419" L="10" Y="215" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="13"/><S X="730" o="05be22" L="10" Y="256" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="13"/><S X="560" o="83ae0b" L="20" Y="236" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="13"/><S X="576" o="129226" L="10" Y="195" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="13"/><S X="617" o="129226" L="29" Y="219" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="13"/><S X="595" o="058419" L="35" Y="232" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="13"/><S X="211" o="058419" L="15" Y="253" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="13"/><S X="253" o="05be22" L="15" Y="288" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="13"/><S X="234" o="058419" L="31" Y="272" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="13"/><S X="54" o="05be22" L="20" Y="239" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="13"/><S X="56" o="83ae0b" L="26" Y="266" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="13"/><S X="79" o="05be22" L="10" Y="279" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="13"/><S X="34" o="058419" L="20" Y="264" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="13"/><S X="774" o="058419" L="28" Y="243" c="4" H="10" P="0,0,0.3,0.2,0,0,0,0" T="13"/></S><D><DS X="431" Y="309"/></D><O/></Z></C>]])
--game variables

tips = {}

local CONSTANTS = {
    BAR_WIDTH = 735,
    BAR_X = 60,
    STAT_BAR_Y = 30,

}


local players = {}
local healthPacks = {}
local courses = {}
local jobs = {}
local companies = {}
local tempData = {} --this table stores temporary data of players when they are creating a new job. Generally contains data in this order: tempPlayer = {jobName = 'MouseClick', jobSalary = 1000, jobEnergy = 0, minLvl = 100, qualification = "a pro"}

local closeButton = "<p align='right'><font color='#ff0000' size='13'><b><a href='event:close'>X</a></b></font></p>"
local nothing = "<br><br><br><br><p align='center'><b><R><font size='15'>Nothing to display!"
local cmds = [[
  <p align='center'><font size='20'><b><J>Commands</J></b></font></p>
  <b>!help:</b>  Displays this dialogue
  <b>!company <i>[company name]:</i></b> Displays the specified compnay
  <b>!p <i>[player name]</i> or !profile <i>[player name]</i></b> Displays information about the specified player
]]
local gameplay = [[
    <p align='center'><font size='20'><b><J>Game Play</J></b></font></p>
    TFM Clicker is a game <b>clicker</b> which is based on an office/working environment. Your goal is to earn money, buy companies, hire workers and be the best businessman in transformice!   
    <b><u>Working:</u></b> You have to work to earn money. You just need to click the 'Work' button in the corner! When you work, it will result in reduction of your health. And also increase in your money. Different jobs have different salaries and energy costs!
    <b><u>Shop:</u></b>  Shop is the place you can buy usesful stuff <font size='8'>(that you all know ^_^)</font>. Bought items are stored temporarily in the inventory. You can use them to increase your health when neaded.
    <b><u>Learning:</u></b> Learning is the only way to get qualifications for some jobs. Higher educational qualifications would result in better jobs. 
    <b><u>Companies:</u></b>  You can buy a company when you have enough money for it. You can use your company to create jobs and recruit workers. (And that will increase your profit more and more!!).  
  ]]
--creating the class Player

local Player = {}
Player.__index = Player
Player.__tostring = function(self)
    return "[name=" .. self.name .. ",money=" .. self.money .. ", health=" .. self.health .. "]"
end

setmetatable(Player, {
    __call = function (cls, name)
        return cls.new(name)
    end,
})

function Player.new(name)
    local self = setmetatable({}, Player)
    self.name = name
    self.money = 0
    self.health = 1.0
    self.healthRate = 0.002
    self.xp = 0
    self.level = 1
    self.learning = ""
    self.learnProgress = 0
    self.eduLvl = 1
    self.eduStream = ""
    self.degrees = {}
    self.job = "Cheese collector"
    self.ownedCompanies = {}
    self.boss = "shaman"
    self.company = "Atelie801"
    self.inventory = {}
    ui.addTextArea(1000, "", name, CONSTANTS.BAR_X, 340, CONSTANTS.BAR_WIDTH, 20, 0xff0000, 0xee0000, 1, true)
    ui.addTextArea(2000, "", name, CONSTANTS.BAR_X, 370, 1, 17, 0x00ff00, 0x00ee00, 1, true)
    return self
end

function Player:getName() return self.name end
function Player:getMoney() return self.money end
function Player:getHealth() return self.health end
function Player:getHealthRate() return self.healthRate end
function Player:getXP() return self.xp end
function Player:getLevel() return self.level end
function Player:getLearningCourse() return self.learning end
function Player:getLearningProgress() return self.learnProgress end
function Player:getEducationLevel() return self.eduLvl end
function Player:getEducationStream() return self.eduStream end
function Player:getDegrees() return self.degrees end
function Player:getOwnedCompanies() return self.ownedCompanies end
function Player:getBoss() return self.boss end
function Player:getInventory() return self.inventory end
function Player:getJob() return self.job end

function Player:work()
    if self.health - find(self.job, jobs).energy > 0 then
        local job = find(self.job, jobs)
        self.setHealth(self, -job.energy, true)
        self:setMoney(job.salary, true)
        self:setXP(1, true)
        players[job.owner]:setMoney(job.salary * 0.2, true)
        self:levelUp()
    end
end

function Player:setHealth(val, add)
    if add then
        self.health = self.health + val
    else
        self.health = val
    end
    self.health = self.health > 1  and 1 or self.health < 0 and 0 or self.health
    ui.addTextArea(1000, "", self.name, CONSTANTS.BAR_X, 340, CONSTANTS.BAR_WIDTH * self.health, 20, 0xff0000, 0xee0000, 1, false)
    ui.updateTextArea(2, "<p align='center'>" .. math.ceil(self.health * 100) .. "%</p>", self.name)
end

function Player:setMoney(val, add)
    if add then
        self.money = self.money + val
    else
        self.money = val
    end
    self.money = self.money < 0 and 0 or self.money
    self:updateStatsBar()
end

function Player:setXP(val, add)
    if add then
        self.xp = self.xp + val
    else
        self.xp = val
    end
    ui.addTextArea(2000, "", self.name, CONSTANTS.BAR_X, 370, ((self.xp - calculateXP(self.level)) / (calculateXP(self.level + 1) - calculateXP(self.level)))  * CONSTANTS.BAR_WIDTH, 17, 0x00ff00, 0x00ee00, 1, false)
    ui.updateTextArea(3, "<p align='center'>Level " .. self.level .. " - " ..self.xp .. "/" .. calculateXP(self.level + 1) .. "XP", self.name)
end

function Player:setCourse(course)
  self.learning = course.name
  self.learnProgress = 0
  self.eduLvl = course.level
  self.eduStream = course.stream
  ui.addTextArea(3000, "Lessons left: 0/" .. find(self.learning, courses).lessons, self.name, 5, 100, 50, 50, nil, nil, 0.8, false)
end

function Player:setJob(job)
  local jobRef = find(job, jobs)
  
  
  
  if jobRef.minLvl <= self.level and (jobRef.qualifications == nil or table.indexOf(self.degrees, jobRef.qualifications) ~= nil) then
    find(self.company, companies):removeMember(self.name)
    self.job = job
    self.boss = jobRef.owner
    self.company = jobRef.company
    find(self.company, companies):addMember(self.name)
  else
    
  end
end

function Player:addOwnedCompanies(comName)
  table.insert(self.ownedCompanies, comName)
end

function Player:addDegree(course)
  table.insert(self.degrees, course)
end

function Player:learn()
  if learning == "" then
    
  else

    if self.money > find(self.learning, courses).feePerLesson then
      self.learnProgress = self.learnProgress + 1
      ui.updateTextArea(3000, "Lessons left:" .. self.learnProgress .. "/" .. find(self.learning, courses).lessons, self.name)
      self:setMoney(-find(self.learning, courses).feePerLesson, true)
      if self.learnProgress >= find(self.learning, courses).lessons then
        self:addDegree(self.learning)
        
        self.learning = ""
        self.eduLvl = self.eduLvl + 1
      end
    end
  end
end

function Player:levelUp()
    if self.xp >= calculateXP(self.level + 1) then
        self.level = self.level + 1
        self:setHealth(1.0, false)
        self:setMoney(5 * self.level, true)
        
        displayParticles(self.name, tfm.enum.particle.star)
    end
end

function Player:useMed(med)
    if not (self.health >= 1) then
        self:setHealth(med.regainVal, med.adding)
        displayParticles(self.name, tfm.enum.particle.heart)
    end
end

function Player:updateStatsBar()
  ui.updateTextArea(10, "<p align='right'>Money: $" .. self.money .." </p> ", self.name)
  ui.updateTextArea(11, " Level: " .. self.level, self.name)
  ui.updateTextArea(1, "<br><p align='center'><b>" .. self.name .. "</b></p>", self.name)
end

function Player:grabItem(item)
  if self.inventory[item] == nil then
    self.inventory[item] = 1
  else 
    self.inventory[item] = self.inventory[item] + 1
  end
end

function Player:useItem(item)
  if self.inventory[item] ~= nil then
    self.inventory[item] = self.inventory[item] - 1
    if self.inventory[item] < 1 then
      self.inventory[item] = nil
    end
  end
end

--class creation(Player) ends

--class creation(Company)
local Company = {}
Company.__index = Company
Company.__tostring = function(self)
    return "[name=" .. self.name .. ",owner=" .. self.owner .. "]"
end

setmetatable(Company, {
    __call = function (cls, ...)
        return cls.new(...)
    end,
})

function Company.new(name, owner)
    local self = setmetatable({}, Company)
    self.name = name
    self.owner = owner
    self.members = {}
    self.jobs = {}
    self.uid = "com:" .. name
    return self
end

function Company:getName() return self.name end
function Company:getOwner() return self.owner end
function Company:getMembers() return self.members end
function Company:getJobs() return self.jobs end
function Company:getUID() return self.uid end

function Company:addMember(name)
  local hasThisMember = false
  for k, v in ipairs(self.members) do
    if v == name then hasThisMember = true end
  end
  if not hasThisMember then
    table.insert(self.members, name)
  end
end

function Company:removeMember(name)
  for k, v in ipairs(self.members) do
      if v == name then
        table.remove(self.members, k)
      end
  end
end

--class creation(Company) ends

--game functions

function displayShop(target, page)
    local medicTxt = ""
    for id, medic in next, {healthPacks[((page - 1) * 2) + 1], healthPacks[page * 2]} do
        medicTxt = medicTxt .. "<b><font size='13'>" .. medic.name  .. "</font></b><br><p align='right'><VP><a href='event:buy:" .. medic.uid .."'><b>| Buy |</b></a></VP></p>Price: " .. medic.price .. "  Energy: " .. (medic.regainVal * 100) .. "%<br>" .. medic.desc .. "<br><br>"    
    end
    ui.addTextArea(100, closeButton .. "<p align='center'><font size='20'><b><J>Shop</J></b></font></p><br></br>" .. (medicTxt == "" and nothing or medicTxt), target, 200, 90, 400, 200, nil, nil, 1, true)
    ui.addTextArea(101, "<p align='center'><a href='event:page:shop:" .. page - 1 .."'>«</a></p>", target, 500, 310, 10, 15, nil, nil, 1, true)
    ui.addTextArea(102, "Page " .. page, target, 523, 310, 50, 15, nil, nil, 1, true)
    ui.addTextArea(103, "<p align='center'><a href='event:page:shop:" .. page + 1 .."'>»</a></p>", target, 585, 310, 15, 15, nil, nil, 1, true)
end

function displayCourses(target)
  local courseTxt = ""
  local p = players[target]
  for id, course in ipairs(courses) do
    if p:getEducationLevel() == course.level and (p:getEducationStream() == course.stream or p:getEducationStream() == "") and learning ~= "" then
      courseTxt = courseTxt .. "<b><font size='13'>" .. course.name .. "</font></b><VP><a href='event:" .. course.uid .. "'><b> | Enroll |</b></a></VP><br><font size='10'>(Fee: " .. course.fee .. " Lessons: " .. course.lessons .. ")</font><br>"
    end
  end
  ui.addTextArea(200, closeButton .. "<p align='center'><font size='20'><b><J>Courses</J></b></font></p><br></br>" .. (courseTxt == "" and nothing or courseTxt), target, 200, 90, 400, 200, nil, nil, 1, true)
end

function displayJobs(target, page)
  local jobTxt = ""
  local p = players[target]
  local qJobs = getQualifiedJobs(target)
  for id, job in next, {qJobs[((page - 1) * 2) + 1], qJobs[page * 2]} do
      jobTxt = jobTxt .. "<b><font size='13'>" .. job.name .. "</font></b><br><p align='right'><b><VP><a href='event:" .. job.uid .. "'> | Choose | </a></VP></b></p>Salary: " .. job.salary .. " Energy: " .. (job.energy * 100) .. "%<br>Offered by <b>" .. job.owner .. "</b> of <b>" .. job.company .. "</b><br><br>"
  end
  ui.addTextArea(300, closeButton .. "<p align='center'><font size='20'><b><J>Jobs</J></b></font></p><br><br>" .. (jobTxt == "" and nothing or jobTxt), target, 200, 90, 400, 200, nil, nil, 1, true)
  ui.addTextArea(301, "<p align='center'><a href='event:page:jobs:" .. page - 1 .."'>«</a></p>", target, 500, 310, 10, 15, nil, nil, 1, true)
  ui.addTextArea(302, "Page " .. page, target, 523, 310, 50, 15, nil, nil, 1, true)
  ui.addTextArea(303, "<p align='center'><a href='event:page:jobs:" .. page + 1 .."'>»</a></p>", target, 585, 310, 15, 15, nil, nil, 1, true)
end

function displayCompanyDialog(target)
  if #players[target]:getOwnedCompanies() == 0 then
    ui.addPopup(400, 1, "<p align='center'>No owned companies<br>Do you want to own one?</p>", target, 300, 90, 200, true)
  else
    local companyTxt = ""
    local p = players[target]
    for k, v in ipairs(p:getOwnedCompanies()) do
      local company = find(v, companies)
      companyTxt = companyTxt .. "<b><a href='event:" .. company:getUID() .. "'>" .. company:getName() .. "</a></b><br>Members: " .. (#company:getMembers() == 0 and "-" or string.sub(table.tostring(company:getMembers()), 2, -3))
    end
    ui.addTextArea(400, closeButton .. "<p align='center'><font size='20'><b><J>My Companies</J></b></font></p><br><br>" .. companyTxt, target, 200, 90, 400, 200, nil, nil, 1, true)
  end
end

function displayCompany(name, target)
  if find(name, companies) ~= nil then
    local com = find(name, companies)
    tempData[target].jobCompany = name

    local companyTxt = ""
    local members = ""
    for k, v in ipairs(com:getMembers()) do
      members = members .. v .. "<br>"
    end
    ui.addTextArea(400, closeButton .. "<p align='center'><font size='20'><b><J>" .. name .. "</J></b></font></p><br><br><b>Owner</b>: " ..  com:getOwner() .. "<br><b>Members</b>: <br>" .. members, target, 200, 90, 400, 200, nil, nil, 1, true)
    if com:getOwner() == target then 
      ui.addTextArea(401, "<a href='event:createJob'>Create Job</a>", target, 500, 310, 100, 20, nil, nil, 1, true)
    end
  else
    ui.addPopup(404, 0, "<p align='center'><b><font color='#CB546B'>Company doesn't exist!", target, 300, 90, 200, true)
  end
end

function displayJobWizard(target)
  ui.addTextArea(500, closeButton .. [[<p align='center'><font size='20'><b><J>Job Wizard</J></b></font></p><br><br>
    <b>Job Name: </b><a href='event:selectJobName'>]] ..  (tempData[target].jobName == nil and "Select" or tempData[target].jobName) .. [[</a>
    <b>Salary: </b><a href='event:selectJobSalary'> ]] .. (tempData[target].jobSalary == nil and "Select" or tempData[target].jobSalary) .. [[</a>
    <b>Enery: </b><a href='event:selectJobEnergy'> ]] .. (tempData[target].jobEnergy == nil and "Select" or tempData[target].jobEnergy) .. [[</a>
    <b>Minimum Level: </b><a href='event:chooseJobMinLvl'>]] .. (tempData[target].minLvl == nil and "Select" or tempData[target].minLvl) .. [[</a>
    <b>Qualifcations: </b><a href='event:chooseJobDegree'>]] .. (tempData[target].qualification == nil and "Select" or tempData[target].qualification) .. [[</a><br>
  ]], target, 200, 90, 400, 200, nil, nil, 1, true) 
end

function displayAllDegrees(target)
  local degreeTxt = ""
  for k, v in ipairs(courses) do
    degreeTxt = degreeTxt .. "<a href='event:degree:" .. v.name .. "'>" .. v.name .. "</a><br>"
  end
  ui.addTextArea(600, closeButton .. "<p align='center'><font size='20'><b><J>Choose a Degree</J></b></font></p>" .. degreeTxt, target, 200, 90, 400, 200, nil, nil, 1, true)
end

function displayInventory(target)
  local invTxt = ""
  for k, v in pairs(players[target]:getInventory()) do
    invTxt = invTxt .. "<b><font size='12'>".. k .. "</font><a href='event:use:" .. k .."'><VP> | Use x" .. v .. " |</VP> </a></b> : <font size='10'>(Energy: " .. (find(k, healthPacks).regainVal * 100) .. "%)</font><br>"
  end
  ui.addTextArea(700, closeButton .. "<p align='center'><font size='20'><b><J>Inventory</J></b></font></p><br>" .. (invTxt == "" and nothing or invTxt), target, 200, 90, 400, 200, nil, nil, 1, true)
end

function displayTips(target)
  ui.addTextArea(800, tips[1], target, 6, 150, 120, 150, 0x324650, 0x000000, 1, true)
  ui.addTextArea(801, "«", target, 10, 315, 10, 15, nil, nil, 1, true)
  ui.addTextArea(802, "Page 1", target, 35, 315, 50, 15, nil, nil, 1, true)
  ui.addTextArea(803, "<p align='center'><a href='event:page:tip:2'>»</a></p>", target, 100, 315, 15, 15, nil, nil, 1, true)
end

function displayProfile(name, target)
  local p = players[name] or players[name .. "#0000"]
  if p then
    ui.addTextArea(900, closeButton .. "<p align='center'><font size='15'><b><BV>" .. p:getName() .."</BV></b></font></p><br><b>Level:</b> " .. tostring(p:getLevel()) .. "<BL><font size='12'> [" .. tostring(p:getXP()) .. "XP / " .. tostring(calculateXP(p:getLevel() + 1)) .. "XP]</font></BL><br><b>Money:</b> $" .. formatNumber(p:getMoney()) .. "<br><br><b>Working as a</b> " .. p:getJob() , target, 300, 100, 200, 130, nil, nil, 1, true)
  end
end

function displayHelp(target, mode)
ui.addTextArea(950, "<B><J><a href='event:cmds'>Commands</a>", target, 30, 130, 75, 20, 0x324650, 0x000000, 1, true)
ui.addTextArea(951, "<a href='event:game'><B><J>Gameplay", target, 30, 95, 75, 20, 0x324650, 0x000000, 1, true)
ui.addTextArea(952, closeButton .. (mode == "game" and gameplay or cmds), target, 100, 90, 600, 230, 0x324650, 0x000000, 1, true)
end

function calculateXP(lvl)
    return 2.5 * (lvl + 2) * (lvl - 1)
end

function displayParticles(target, particle)
  tfm.exec.displayParticle(particle, tfm.get.room.playerList[target].x, tfm.get.room.playerList[target].y, 0, -2, 0, 0, nil)
  tfm.exec.displayParticle(particle, tfm.get.room.playerList[target].x - 10, tfm.get.room.playerList[target].y, 0, -3, 0, 0, nil)
  tfm.exec.displayParticle(particle, tfm.get.room.playerList[target].x + 10, tfm.get.room.playerList[target].y, 0, -2, 0, 0, nil)
  tfm.exec.displayParticle(particle, tfm.get.room.playerList[target].x + math.random(-15, 15) , tfm.get.room.playerList[target].y, 0, -1, 0, 0, nil)
end

function getQualifiedJobs(player)
    local p = players[player]
    local qjobs = {}
    for id, job in ipairs(jobs) do
        if p:getLevel() >= job.minLvl and (job.qualifications == nil or table.indexOf(p:getDegrees(), job.qualifications) ~= nil) then
                table.insert(qjobs, job)
        end
    end
    return qjobs
end

function find(name, tbl)
  for k,v in ipairs(tbl) do
    if (v.name == name) then
      return v
    end
  end
  return nil
end

function createTip(tip, index)
  tips[index] = closeButton .. "<p align='center'><J><b>Tips!</b></J><br><br>" .. tip
end

--[[copied from the internet. lazy to write it by myself :D
  Credits: walterlua (https://gist.github.com/walterlua/978150/2742d9479cd5bfb3d08d90cfcb014da94021e271)
           jakbyte
]]
function table.indexOf(t, object)
    if type(t) ~= "table" then error("table expected, got " .. type(t), 2) end
    for i, v in pairs(t) do
        if object == v then
            return i
        end
    end
end

--[[copied from stackoverflow
  Credits: https://stackoverflow.com/users/1514861/ivo-beckers
  Question: https://stackoverflow.com/questions/1426954/split-string-in-lua
]]
function split(s, delimiter)
    result = {};
    for match in (s..delimiter):gmatch("(.-)"..delimiter) do
        table.insert(result, match);
    end
    return result;
end

function table.tostring(tbl)
  s = "["
  for k, v in pairs(tbl) do
    s = s .. k .. ":" .. v .. ", "
  end
  return s .. "]"
end

function formatNumber(n)
  if n >= 1000000000000 then
    return math.floor(n / 100000000000) .. "T"
  elseif n >= 1000000000 then
    return math.floor(n / 100000000) .. "B"
  elseif n >= 1000000 then
    return math.floor(n / 100000) .. "M"
  elseif n >= 10000 then
    return math.floor(n / 1000) .. "K"
  end
  return n
end

function getTotalPages(type, target)
  if type == 'tip' then
    return #tips
  elseif type == 'shop' then
    return #healthPacks / 2 + (#healthPacks % 2)
  elseif type == 'jobs' then
      return #getQualifiedJobs(target) / 2 + (#getQualifiedJobs(target) % 2)
  end
  
  return 0
end

function updatePages(name, type, page)
  if not (page < 1 or page > getTotalPages(type, name)) then         
      if type == 'tip' then
        ui.updateTextArea(800, tips[page] or "", name)
        ui.updateTextArea(801, "<a href='event:page:tip:" .. (page - 1) .. "'>«</a>", name)
        ui.updateTextArea(802, "<p align='center'>Page " .. page .. "</p>", name)
        ui.updateTextArea(803, "<a href='event:page:tip:" .. (page + 1) .. "'>»</a>", name)
      elseif type == 'shop' then
        displayShop(name, page)
      elseif type == 'jobs' then
          displayJobs(name, page)
      end
  end
end

function HealthPack(_name, _price, _regainVal, _adding, _desc)
  return {
    name = _name,
    price = _price,
    regainVal = _regainVal,
    adding = _adding,
    uid = "health:" .. _name,
    desc = _desc
  }
end

function Course(_name, _fee, _lessons, _level, _stream)
  return {
    name = _name,
    fee = _fee,
    lessons = _lessons,
    level = _level,
    stream = _stream,
    feePerLesson = _fee / _lessons,
    uid = "course:" .. _name 
  }
end

function Job(_name, _salary, _energy, _minLvl, _qualifications, _owner, _company)
  return {
    name = _name,
    salary = _salary,
    energy = _energy,
    minLvl = _minLvl,
    qualifications = _qualifications,
    owner = _owner,
    company = _company,
    uid = "job:" .. _name
  }
end

function setUI(name)
    --textAreas
    --work
    ui.addTextArea(0, "<a href='event:work'><br><p align='center'><b>Work!</b></p>", name, 5, 340, 45, 50, 0x324650, 0x000000, 1, true)
    --stats
    --ui.addTextArea(1, name .. "<br>Money : $0 | Level 1", name, 6, CONSTANTS.STAT_BAR_Y, 785, 40, 0x324650, 0x000000, 1, true)
    ui.addTextArea(10, "<p align='right'>Money: $0 </p> ", name, 200, 25, 120, 20, nil, nil, 1, true)
    ui.addTextArea(11, " Level: 1", name, 480, 25, 120, 20, nil, nil, 1, true)
    ui.addTextArea(1, "<br><p align='center'><b>" .. name .. "</b></p>", name, 325, 20, 150, 30, nil, nil, 1, true )
    --health bar area
    ui.addTextArea(2, "<p align='center'>100%</p>", name, CONSTANTS.BAR_X, 340, CONSTANTS.BAR_WIDTH, 20, nil, nil, 0.5, false)
    --xp bar area
    ui.addTextArea(3, "<p align='center'>Level 1  -  0/" .. calculateXP(2) .. "XP</p>", name, CONSTANTS.BAR_X, 370, CONSTANTS.BAR_WIDTH, 20, nil, nil, 0.5, true)
    --shop button
    ui.addTextArea(4, "<a href='event:shop'>Shop</a>", name, 740, 300, 36, 20, nil, nil, 1, true)
    --school button
    ui.addTextArea(5, "<a href='event:courses'>Learn</a>", name, 740, 270, 36, 20, nil, nil, 1, true)
    --jobs button
    ui.addTextArea(6, "<a href='event:jobs'>Jobs</a>", name, 740, 240, 36, 20, nil, nil, 1, true)
    --Company button
    ui.addTextArea(7, "<a href='event:company'>Company</a>", name, 740, 210, 36, 20, nil, nil, 1, true)
    --Tips buton
    ui.addTextArea(8, "<a href='event:tips'>Tips</a>", name, 740, 180, 36, 20, nil, nil, 1, true)
    --Inventory button
    ui.addTextArea(9, "<a href='event:inv'>Inventory</a>", name, 740, 150, 36, 20, nil, nil, 1, true)
end

--event handling

function eventNewPlayer(name)
    players[name] = Player(name)
    tempData[name] = {}
    
    setUI(name)
    tfm.exec.respawnPlayer(name)
end

--[[Function removed because it affects UX
function eventPlayerLeft(name)
    for n, player in ipairs(players) do
        if player:getName() == name then
            table.remove(players, n)
        end
    end
end
]]

function eventPlayerDied(name)
  tfm.exec.respawnPlayer(name)
end
  
--function for the money clicker c:
function eventTextAreaCallback(id, name, evt)
    if evt == "work" then
        players[name]:work()
    elseif evt == "tips" then
       displayTips(name)
    elseif evt == "cmds" then
        displayHelp(name, "cmds")
    elseif evt == "game" then
        displayHelp(name, "game")
    elseif string.sub(evt, 1, 4) == "page" then
        local args = split(evt, ":")
        updatePages(name, args[2], tonumber(args[3]))
    elseif evt == "shop" then
        displayShop(name, 1)
    elseif evt == "courses" then
        if players[name]:getLearningCourse() == "" then
          displayCourses(name)
        else 
          players[name]:learn()
        end
    elseif evt == "jobs" then
        displayJobs(name, 1)
    elseif evt == "inv" then
      displayInventory(name)    
    elseif evt == "close" then
        ui.removeTextArea(id, name)
        if id == 400 then 
          ui.removeTextArea(401, name) 
        elseif id == 800 then
          ui.removeTextArea(801, name)
          ui.removeTextArea(802, name)
          ui.removeTextArea(803, name)
        elseif id == 100 then
          ui.removeTextArea(101, name)
          ui.removeTextArea(102, name)
          ui.removeTextArea(103, name)
        elseif id == 300 then
            ui.removeTextArea(301, name)
            ui.removeTextArea(302, name)
            ui.removeTextArea(303, name)
        elseif id == 952 then
            ui.removeTextArea(950, name)
            ui.removeTextArea(951, name)
        end
    elseif evt == "company" then
        displayCompanyDialog(name)
    elseif evt == "createJob" then
        if tempData[name].jobName == nil and tempData[name].jobSalary == nil and tempData[name].jobEnergy == nil and tempData[name].minLvl == nil then
          displayJobWizard(name)
        else
          
          local tempCompany = tempData[name].jobCompany
          table.insert(jobs, Job(tempData[name].jobName, tempData[name].jobSalary, tempData[name].jobEnergy / 100, tempData[name].minLvl, tempData[name].qualification, name, tempData[name].jobCompany))
          tempData[name] = {jobCompany = tempCompany}
          ui.removeTextArea(500, name)
        end
    elseif evt == "selectJobName" then
        ui.addPopup(601, 2, "<p align='center'>Please choose a name", name, 300, 90, 200, true)  
    elseif evt == "selectJobSalary" then
        ui.addPopup(602, 2, "<p align='center'>Please choose the salary (<i>Should be a number lesser that 1000000</i>)", name, 300, 90, 200, true)  
    elseif evt == "selectJobEnergy" then
        ui.addPopup(603, 2, "<p align='center'>Please select the energy (<i>Should be a number in range 0 - 100</i>)", name, 300, 90, 200, true)  
    elseif evt == "chooseJobMinLvl" then
        ui.addPopup(604, 2, "<p align='center'>Please select the minimum level (<i>Should be a number</i>", name, 300, 90, 200, true)
    elseif evt == "chooseJobDegree" then
        displayAllDegrees(name)
    elseif evt:gmatch("%s+:%s+") then
        local type = split(evt, ":")[1]
        local val = split(evt, ":")[2]
        if type == "buy" and players[name]:getMoney() - find(split(evt, ":")[3], healthPacks).price >= 0 then
          local pack = find(split(evt, ":")[3], healthPacks)
          players[name]:setMoney(-pack.price, true)
          players[name]:grabItem(pack.name)
          
        elseif type == "course" then
          players[name]:setCourse(find(val, courses))
          ui.removeTextArea(id, name)
        elseif type == "job" then      
          players[name]:setJob(val)
          ui.removeTextArea(id, name)
        elseif type == "com" then
          displayCompany(val, name)
        elseif type == "degree" then
          tempData[name].qualification = val
          ui.removeTextArea(id, name)
          displayJobWizard(name)
        elseif type == "use" then
          players[name]:useItem(val)
          players[name]:useMed(find(val, healthPacks))
          displayInventory(name)
        end 
    end
end

function eventPopupAnswer(id, name, answer)
  
  
  if id == 400 and answer == 'yes' then --for the popup creating a compnay
    if players[name]:getMoney() < 5000 then
      ui.addPopup(450, 0, "<p align='center'><b><font color='#CB546B'>Not enough money!", name, 300, 90, 200, true)
    else 
      ui.addPopup(450, 2, "<p align='center'>Please choose a name<br>Price: $5000<br>Click submit to buy!</p>", name, 300, 90, 200, true)
    end
  elseif id == 450 and answer ~= '' then --for the popup to submit a name for the company
    table.insert(companies, Company(answer, name))
    players[name]:setMoney(-5000, true)
    players[name]:addOwnedCompanies(answer)
    displayCompany(answer, name)
  elseif id == 601 and answer ~= '' then --for the popup to submit the name for a new job
    tempData[name].jobName = answer
    displayJobWizard(name)
  elseif id == 602 and tonumber(answer) and tonumber(answer) < 1000000 then --for the popup to choose the salary for a new job
    tempData[name].jobSalary = tonumber(answer)
    displayJobWizard(name)
  elseif id == 603 and tonumber(answer) and tonumber(answer) > 0 and tonumber(answer) <= 100 then --for the popup to choose the energy for the job
    tempData[name].jobEnergy = tonumber(answer)
    displayJobWizard(name)
  elseif id == 604 and tonumber(answer) then --for the popup to choose the minimum level for the job
    tempData[name].minLvl = tonumber(answer)
    displayJobWizard(name)
  end
  
end

function eventChatCommand(name, msg)
  if string.sub(msg, 1, 7) == "company" then
    displayCompany(string.sub(msg, 9), name)
  elseif string.sub(msg, 1, 7) == "profile" then
    displayProfile(string.sub(msg, 9), name)
  elseif string.sub(msg, 1, 1) == "p"  then
    displayProfile(string.sub(msg, 3), name)
  elseif msg == "help" then
    displayHelp(name, "game")
  end
end

function eventLoop(t,r)
    for name, player in pairs(players) do
        player:setHealth(player:getHealthRate(), true)
    end
end

--event handling ends

--game logic
--creating tips
createTip("You Need $10 To Start A New Company!", 1)
createTip("You Gain Money From Your Workers!", 2)
createTip("Look At The Stats of The Company Before You Apply for it!", 3)
createTip("The Better The Job The Better The Income!", 4)
createTip("Buy Items From The Shop To Gain Health!", 5)
createTip("Some Jobs Needs A Specific Degree", 6)
createTip("To Level Up You Need To Work!", 7)
createTip("The Higher The Level The Higher The Health", 8)
createTip("The Stats Of A Company Can Be Seen By Anyone", 9)
createTip("While Working Your Health Bar Goes Down", 10)
createTip("Patience is The Key To This Game.", 11)
createTip("Your Stats Can Be Seen At The Top Of The Map!", 12)
createTip("You Can Buy Multiple Companies!", 13)
createTip("Once You Have A Job You Can't Quit!", 14)
createTip("Your Health will be Refreshed when You Level Up", 15)
createTip("Recruit More Players to Have More Salary!", 16)
createTip("Try your Best to Own a Company", 17)
createTip("Make Sure You Consider About Energy and Salary When Choosing a Job", 18)
createTip("The Red Bar Displays Your Health, While the Green Bar Displays your XP Percentage", 19)
createTip("Chat With Your Friends When You Are Out of Health", 20)
createTip("Use Your Brain and Take Correct Decisions!", 21)
createTip("If Your Job Seems to Take More Energy, Try to Choose Another!", 22)
createTip("Consider About Your Health When Working", 23)
createTip("When Taking A Course, You will Need to Pay Per Lesson Only. So Try to Enroll For the One With Higher Lessons", 24)
createTip("You Can Apply to Jobs According to Your Level and Degrees", 25)
createTip("The Better Stats You Have The Better The Job You Can Have!", 26)
createTip("Report Bugs To Developers", 27)
createTip("The Game is More Fun with More Players", 28)
createTip("Click Tips When You Need Help", 29)
createTip("The Health Refreshes Every Moment <3", 30)

players["shaman"] = Player("shaman")
table.insert(companies, Company("Atelie801", "shaman"))

--creating and storing HealthPack tables
table.insert(healthPacks, HealthPack("Cheese", 5, 0.01, true,  "Just a cheese! to refresh yourself"))
table.insert(healthPacks, HealthPack("Candy", 10, 0.02, true, "Halloween Treat!"))
table.insert(healthPacks, HealthPack("Apple", 15, 0.025, true, "A nutritious diet from shaman"))
table.insert(healthPacks, HealthPack("Pastry", 30, 0.06, true, "King's favourite food"))
table.insert(healthPacks, HealthPack("Lasagne", 100, 0.1, true, "Shh!!! Beware of Garfield :D"))
table.insert(healthPacks, HealthPack("Cheese Pizza", 130, 0.15, true, "Treat from Italy - with lots of cheeese inside !!!"))
table.insert(healthPacks, HealthPack("Magician`s Portion", 250, 0.25, true, "Restores 1/4 th of your health."))
table.insert(healthPacks, HealthPack("Rotten Cheese", 300, 0.35, true, "Gives you the power of vampire <font size='5'>(disclaimer)This won't make you a vampire</font>"))
table.insert(healthPacks, HealthPack("Cheef`s food", 500, 0.5, true, "Restores half of your health (Powered by Shaman)"))
table.insert(healthPacks, HealthPack("Cheese Pizza - Large", 550, 0.55, true, "More Pizza Power!"))
table.insert(healthPacks, HealthPack("Vito`s Pizza", 700, 0.6, true, "World's best pizza!"))
table.insert(healthPacks, HealthPack("Vito`s Lasagne", 750, 0.8, true, "World's best lasagne!"))
table.insert(healthPacks, HealthPack("Ambulance!", 999, 1, false, "Restores your health back! (Powered by Shaman!)"))


--creating and storing Course tables
table.insert(courses, Course("School", 20, 2, 1, ""))
table.insert(courses, Course("Junior Sports Club", 10, 4, 2, ""))
table.insert(courses, Course("High School", 500, 20, 3, ""))
table.insert(courses, Course("Cheese mining", 1000, 30, 4, "admin"))
table.insert(courses, Course("Cheese trading", 2500, 30, 4, "bs"))
table.insert(courses, Course("Cheese developing", 2500, 50, 4, "it"))
table.insert(courses, Course("Law", 35000, 80, 5, "admin"))
table.insert(courses, Course("Cheese trading-II", 90000, 75, 5, "bs"))
table.insert(courses, Course("Fullstack cheese developing", 40000, 70, 5, "it"))
--creating and stofing Job tables
table.insert(jobs, Job("Cheese collector", 10, 0.05, 1, nil, "shaman", "Atelie801"))
table.insert(jobs, Job("Junior miner", 25, 0.1, 3, nil, "shaman", "Atelie801"))
table.insert(jobs, Job("Cheese producer", 50, 0.15, 7, nil, "shaman", "Atelie801"))
table.insert(jobs, Job("Cheese miner", 250, 0.2, 10, "Cheese mining", "shaman", "Atelie801"))
table.insert(jobs, Job("Cheese trader", 200, 0.2, 12, "Cheese trading", "shaman"))
table.insert(jobs, Job("Cheese developer", 300, 0.3, 12, "Cheese developing", "shaman", "Atelie801"))
table.insert(jobs, Job("Cheese wholesaler", 700, 0.2, 15, "Cheese trading-II", "shaman", "Atelie801"))
table.insert(jobs, Job("Fullstack cheeese developer", 9000, 0.4, 15, "Fullstack cheese developing", "shaman", "Atelie801"))

for name, player in pairs(tfm.get.room.playerList) do
    players[name] = Player(name)
    setUI(name)
    tempData[name] = {}
end

for id, cmd in next, {"company", "p", "profile", "help"} do
  system.disableChatCommandDisplay(cmd, true)
end
